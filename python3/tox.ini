[tox]
envlist = py3
skipsdist = true
toxworkdir = /tmp/lone/.tox


[coverage:run]
omit = setup.py


[coverage:html]
directory = /tmp/lone/htmlcov


[testenv]
allowlist_externals =
    pip
    rm
    lone_setup
    pylama
    pytest


commands =
  # Install lone and dependencies
  pip install --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org .
  lone_setup --help

  # Run unit tests with pytest, pytest-cov, pytest-mock using the nvsim simulator
  pytest -v {tty:--color=yes} \
    tests/ \
    --log-level=INFO \
    --show-capture=log \
    --cov=lone/ --cov-fail-under=100 --cov-report=html --cov-report=term-missing \
    --cov-branch

  # Run pytests against simulator
  pytest -v {tty:--color=yes} \
    nvtest/ \
    --log-level=INFO \
    --show-capture=log \
    --pci-slot nvsim \
    --config nvtest/tox_cov.yml

  # Run some scripts against the simulator
  python3 scripts/nvme/list.py --pci-slot nvsim
  python3 scripts/nvme/rw.py nvsim 1
  python3 scripts/nvme/rw.py nvsim 2

  # Run pylama
  pylama
